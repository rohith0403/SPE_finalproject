{"ast":null,"code":"const debug = require(\"debug\")(\"log4js:clustering\");\n\nconst LoggingEvent = require(\"./LoggingEvent\");\n\nconst configuration = require(\"./configuration\");\n\nlet disabled = false;\nlet cluster = null;\n\ntry {\n  cluster = require(\"cluster\"); //eslint-disable-line\n} catch (e) {\n  debug(\"cluster module not present\");\n  disabled = true;\n}\n\nconst listeners = [];\nlet pm2 = false;\nlet pm2InstanceVar = \"NODE_APP_INSTANCE\";\n\nconst isPM2Master = () => pm2 && process.env[pm2InstanceVar] === \"0\";\n\nconst isMaster = () => disabled || cluster.isMaster || isPM2Master();\n\nconst sendToListeners = logEvent => {\n  listeners.forEach(l => l(logEvent));\n}; // in a multi-process node environment, worker loggers will use\n// process.send\n\n\nconst receiver = (worker, message) => {\n  // prior to node v6, the worker parameter was not passed (args were message, handle)\n  debug(\"cluster message received from worker \", worker, \": \", message);\n\n  if (worker.topic && worker.data) {\n    message = worker;\n    worker = undefined;\n  }\n\n  if (message && message.topic && message.topic === \"log4js:message\") {\n    debug(\"received message: \", message.data);\n    const logEvent = LoggingEvent.deserialise(message.data);\n    sendToListeners(logEvent);\n  }\n};\n\nif (!disabled) {\n  configuration.addListener(config => {\n    // clear out the listeners, because configure has been called.\n    listeners.length = 0;\n    ({\n      pm2,\n      disableClustering: disabled,\n      pm2InstanceVar = \"NODE_APP_INSTANCE\"\n    } = config);\n    debug(`clustering disabled ? ${disabled}`);\n    debug(`cluster.isMaster ? ${cluster && cluster.isMaster}`);\n    debug(`pm2 enabled ? ${pm2}`);\n    debug(`pm2InstanceVar = ${pm2InstanceVar}`);\n    debug(`process.env[${pm2InstanceVar}] = ${process.env[pm2InstanceVar]}`); // just in case configure is called after shutdown\n\n    if (pm2) {\n      process.removeListener(\"message\", receiver);\n    }\n\n    if (cluster && cluster.removeListener) {\n      cluster.removeListener(\"message\", receiver);\n    }\n\n    if (disabled || config.disableClustering) {\n      debug(\"Not listening for cluster messages, because clustering disabled.\");\n    } else if (isPM2Master()) {\n      // PM2 cluster support\n      // PM2 runs everything as workers - install pm2-intercom for this to work.\n      // we only want one of the app instances to write logs\n      debug(\"listening for PM2 broadcast messages\");\n      process.on(\"message\", receiver);\n    } else if (cluster.isMaster) {\n      debug(\"listening for cluster messages\");\n      cluster.on(\"message\", receiver);\n    } else {\n      debug(\"not listening for messages, because we are not a master process\");\n    }\n  });\n}\n\nmodule.exports = {\n  onlyOnMaster: (fn, notMaster) => isMaster() ? fn() : notMaster,\n  isMaster,\n  send: msg => {\n    if (isMaster()) {\n      sendToListeners(msg);\n    } else {\n      if (!pm2) {\n        msg.cluster = {\n          workerId: cluster.worker.id,\n          worker: process.pid\n        };\n      }\n\n      process.send({\n        topic: \"log4js:message\",\n        data: msg.serialise()\n      });\n    }\n  },\n  onMessage: listener => {\n    listeners.push(listener);\n  }\n};","map":{"version":3,"sources":["/Users/osurihimeshkrishna/Downloads/Academics/8th Semester/Software Production Engineering/spe_finalproject/my-app/node_modules/log4js/lib/clustering.js"],"names":["debug","require","LoggingEvent","configuration","disabled","cluster","e","listeners","pm2","pm2InstanceVar","isPM2Master","process","env","isMaster","sendToListeners","logEvent","forEach","l","receiver","worker","message","topic","data","undefined","deserialise","addListener","config","length","disableClustering","removeListener","on","module","exports","onlyOnMaster","fn","notMaster","send","msg","workerId","id","pid","serialise","onMessage","listener","push"],"mappings":"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","sourcesContent":["const debug = require(\"debug\")(\"log4js:clustering\");\nconst LoggingEvent = require(\"./LoggingEvent\");\nconst configuration = require(\"./configuration\");\n\nlet disabled = false;\nlet cluster = null;\ntry {\n  cluster = require(\"cluster\"); //eslint-disable-line\n} catch (e) {\n  debug(\"cluster module not present\");\n  disabled = true;\n}\n\nconst listeners = [];\n\nlet pm2 = false;\nlet pm2InstanceVar = \"NODE_APP_INSTANCE\";\n\nconst isPM2Master = () => pm2 && process.env[pm2InstanceVar] === \"0\";\nconst isMaster = () => disabled || cluster.isMaster || isPM2Master();\n\nconst sendToListeners = logEvent => {\n  listeners.forEach(l => l(logEvent));\n};\n\n// in a multi-process node environment, worker loggers will use\n// process.send\nconst receiver = (worker, message) => {\n  // prior to node v6, the worker parameter was not passed (args were message, handle)\n  debug(\"cluster message received from worker \", worker, \": \", message);\n  if (worker.topic && worker.data) {\n    message = worker;\n    worker = undefined;\n  }\n  if (message && message.topic && message.topic === \"log4js:message\") {\n    debug(\"received message: \", message.data);\n    const logEvent = LoggingEvent.deserialise(message.data);\n    sendToListeners(logEvent);\n  }\n};\n\nif (!disabled) {\n  configuration.addListener(config => {\n    // clear out the listeners, because configure has been called.\n    listeners.length = 0;\n\n    ({\n      pm2,\n      disableClustering: disabled,\n      pm2InstanceVar = \"NODE_APP_INSTANCE\"\n    } = config);\n\n    debug(`clustering disabled ? ${disabled}`);\n    debug(`cluster.isMaster ? ${cluster && cluster.isMaster}`);\n    debug(`pm2 enabled ? ${pm2}`);\n    debug(`pm2InstanceVar = ${pm2InstanceVar}`);\n    debug(`process.env[${pm2InstanceVar}] = ${process.env[pm2InstanceVar]}`);\n\n    // just in case configure is called after shutdown\n    if (pm2) {\n      process.removeListener(\"message\", receiver);\n    }\n    if (cluster && cluster.removeListener) {\n      cluster.removeListener(\"message\", receiver);\n    }\n\n    if (disabled || config.disableClustering) {\n      debug(\"Not listening for cluster messages, because clustering disabled.\");\n    } else if (isPM2Master()) {\n      // PM2 cluster support\n      // PM2 runs everything as workers - install pm2-intercom for this to work.\n      // we only want one of the app instances to write logs\n      debug(\"listening for PM2 broadcast messages\");\n      process.on(\"message\", receiver);\n    } else if (cluster.isMaster) {\n      debug(\"listening for cluster messages\");\n      cluster.on(\"message\", receiver);\n    } else {\n      debug(\"not listening for messages, because we are not a master process\");\n    }\n  });\n}\n\nmodule.exports = {\n  onlyOnMaster: (fn, notMaster) => (isMaster() ? fn() : notMaster),\n  isMaster,\n  send: msg => {\n    if (isMaster()) {\n      sendToListeners(msg);\n    } else {\n      if (!pm2) {\n        msg.cluster = {\n          workerId: cluster.worker.id,\n          worker: process.pid\n        };\n      }\n      process.send({ topic: \"log4js:message\", data: msg.serialise() });\n    }\n  },\n  onMessage: listener => {\n    listeners.push(listener);\n  }\n};\n"]},"metadata":{},"sourceType":"script"}